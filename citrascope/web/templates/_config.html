    <div class="container my-4" id="configSection" x-show="$store.citrascope.currentSection === 'config'" x-cloak>
        <form @submit.prevent="window.saveConfiguration($event)">
            <div class="row g-3 mb-3">
                <!-- API Configuration Card -->
                <div class="col-12" x-data="{ apiCardExpanded: $persist(true).as('apiCard') }">
                    <div class="card bg-dark text-light border-secondary">
                        <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" @click="apiCardExpanded = !apiCardExpanded">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-cloud-arrow-up"></i>
                                <h5 class="mb-0">API Configuration</h5>
                                <small class="text-muted" x-show="!apiCardExpanded && !$store.citrascope.config.use_dummy_api" x-text="$store.citrascope.apiEndpoint === 'production' ? 'Production' : ($store.citrascope.apiEndpoint === 'development' ? 'Development' : 'Custom')"></small>
                                <span x-show="!apiCardExpanded && $store.citrascope.config.use_dummy_api"
                                      class="badge bg-warning text-dark">
                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>Dummy API
                                </span>
                            </div>
                            <i class="bi" :class="apiCardExpanded ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                        </div>
                        <div class="card-body" x-show="apiCardExpanded">
                            <div x-show="$store.citrascope.config.use_dummy_api"
                                 class="alert alert-warning mb-3 py-2" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>Dummy API is active — these settings are ignored. You can change this in Advanced Settings below.
                            </div>
                            <div class="row g-3" :class="$store.citrascope.config.use_dummy_api ? 'opacity-50' : ''">
                                <div class="col-12">
                                    <label for="apiEndpoint" class="form-label">API Endpoint</label>
                                    <select id="apiEndpoint" class="form-select" x-model="$store.citrascope.apiEndpoint">
                                        <option value="production">Production (api.citra.space)</option>
                                        <option value="development">Development (dev.api.citra.space)</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="col-12" id="customHostContainer" x-show="$store.citrascope.apiEndpoint === 'custom'">
                                    <label for="customHost" class="form-label">Custom API Host</label>
                                    <input type="text" id="customHost" class="form-control" placeholder="api.example.com" x-model="$store.citrascope.config.host">
                                    <div class="row g-2 mt-2">
                                        <div class="col-6">
                                            <label for="customPort" class="form-label small">Port</label>
                                            <input type="number" id="customPort" class="form-control" placeholder="443" x-model.number="$store.citrascope.config.port">
                                        </div>
                                        <div class="col-6 d-flex align-items-end">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="customUseSsl" x-model="$store.citrascope.config.use_ssl">
                                                <label class="form-check-label" for="customUseSsl">
                                                    Use SSL
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="personal_access_token" class="form-label">Personal Access Token <span class="text-danger">*</span></label>
                                    <input type="password" id="personal_access_token" class="form-control" placeholder="Enter your Citra API token" required x-model="$store.citrascope.config.personal_access_token">
                                    <small class="text-muted">Get your token and telescope ID from <a :href="$store.citrascope.config.app_url || ''" target="_blank" x-text="($store.citrascope.config.app_url || '').replace('https://', '')"></a></small>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="telescopeId" class="form-label">Telescope ID <span class="text-danger">*</span></label>
                                    <input type="text" id="telescopeId" class="form-control" placeholder="Enter telescope ID" required x-model="$store.citrascope.config.telescope_id">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                {% include '_config_hardware.html' %}


                <!-- Image Processing Settings Card -->
                <div class="col-12" x-data="{ processorCardExpanded: $persist(true).as('processorCard') }">
                    <div class="card bg-dark text-light border-secondary">
                        <div class="card-header d-flex justify-content-between align-items-center"
                             style="cursor: pointer;" @click="processorCardExpanded = !processorCardExpanded">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-cpu"></i>
                                <h5 class="mb-0">Image Processing</h5>
                                <small class="text-muted" x-show="!processorCardExpanded"
                                       x-text="$store.citrascope.config.processors_enabled ? 'Enabled' : 'Disabled'"></small>
                            </div>
                            <i class="bi" :class="processorCardExpanded ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                        </div>
                        <div class="card-body" x-show="processorCardExpanded">
                            <div class="row g-3">
                                <!-- Left Column: Pipeline Toggle -->
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3"><i class="bi bi-toggle-on me-2"></i>Pipeline Control</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="processors_enabled"
                                               x-model="$store.citrascope.config.processors_enabled">
                                        <label class="form-check-label" for="processors_enabled">
                                            Enable image processing pipeline
                                        </label>
                                    </div>
                                    <small class="text-muted d-block mt-2">
                                        Process images before upload to extract readings and filter bad images
                                    </small>
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="bi bi-folder me-1"></i>
                                            Working directory: <span class="text-secondary" x-text="$store.citrascope.config.processing_dir_path || 'Not configured'">Loading...</span>
                                        </small>
                                        <small class="text-muted d-block mt-1">
                                            Temporary files for active tasks (auto-cleaned on success)
                                        </small>
                                    </div>
                                </div>

                                <!-- Right Column: Available Processors -->
                                <div class="col-md-6" x-show="$store.citrascope.processors?.length > 0">
                                    <h6 class="text-muted mb-3"><i class="bi bi-gear-fill me-2"></i>Available Processors</h6>
                                    <div>
                                        <template x-for="processor in $store.citrascope.processors" :key="processor.name">
                                            <div class="mb-2">
                                                <div class="form-check">
                                                    <input
                                                        class="form-check-input"
                                                        type="checkbox"
                                                        :id="'processor-' + processor.name"
                                                        :checked="processor.enabled"
                                                        @change="$store.citrascope.config.enabled_processors[processor.name] = $event.target.checked"
                                                    >
                                                    <label class="form-check-label" :for="'processor-' + processor.name">
                                                        <strong x-text="processor.friendly_name"></strong>
                                                    </label>
                                                </div>
                                                <small class="text-muted ms-4 d-block" x-text="processor.description"></small>
                                                <div class="ms-4 mt-1"
                                                     x-show="$store.citrascope.status?.pipeline_stats?.processors?.[processor.name]?.runs > 0">
                                                    <div class="progress" style="height: 3px; cursor: default;"
                                                         x-init="new bootstrap.Tooltip($el, {
                                                             placement: 'top',
                                                             trigger: 'hover',
                                                             title() {
                                                                 const s = $store.citrascope.status?.pipeline_stats?.processors?.[processor.name];
                                                                 if (!s) return '';
                                                                 const ok = s.runs - s.failures;
                                                                 return `${ok} ok · ${s.failures} failed · ${s.runs} runs`;
                                                             }
                                                         })">
                                                        <div class="progress-bar bg-success" role="progressbar"
                                                             :style="`width: ${(($store.citrascope.status.pipeline_stats.processors[processor.name].runs - $store.citrascope.status.pipeline_stats.processors[processor.name].failures) / $store.citrascope.status.pipeline_stats.processors[processor.name].runs) * 100}%`"></div>
                                                        <div class="progress-bar bg-danger" role="progressbar"
                                                             :style="`width: ${($store.citrascope.status.pipeline_stats.processors[processor.name].failures / $store.citrascope.status.pipeline_stats.processors[processor.name].runs) * 100}%`"></div>
                                                    </div>
                                                    <small class="text-muted d-block mt-1"
                                                           x-show="$store.citrascope.status.pipeline_stats.processors[processor.name].last_failure_reason"
                                                           x-text="'Last failure: ' + $store.citrascope.status.pipeline_stats.processors[processor.name].last_failure_reason">
                                                    </small>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Time & Location Settings Card -->
                <div class="col-12" x-data="{ timeLocationCardExpanded: $persist(true).as('timeLocationCard') }">
                    <div class="card bg-dark text-light border-secondary">
                        <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" @click="timeLocationCardExpanded = !timeLocationCardExpanded">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-globe"></i>
                                <h5 class="mb-0">Time & Location</h5>
                                <small class="text-muted" x-show="!timeLocationCardExpanded"
                                       x-text="'Time sync: ' + ($store.citrascope.config.time_check_interval_minutes || 5) + 'min • GPS: ' + ($store.citrascope.config.gps_location_updates_enabled !== false ? 'Enabled' : 'Disabled')"></small>
                            </div>
                            <i class="bi" :class="timeLocationCardExpanded ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                        </div>
                        <div class="card-body" x-show="timeLocationCardExpanded">
                            <div class="row g-3">
                                <!-- Left Column: Time Synchronization -->
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3"><i class="bi bi-clock-history me-2"></i>Time Synchronization</h6>
                                    <div class="mb-3">
                                        <label for="time_offset_pause_ms" class="form-label">Pause Threshold (ms)</label>
                                        <input type="number" class="form-control form-control-sm" id="time_offset_pause_ms" min="1" max="10000" step="1" x-model.number="$store.citrascope.config.time_offset_pause_ms">
                                        <small class="text-muted">Clock drift that triggers task pause</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="time_check_interval_minutes" class="form-label">Check Interval (minutes)</label>
                                        <input type="number" class="form-control form-control-sm" id="time_check_interval_minutes" min="1" max="60" step="1" x-model.number="$store.citrascope.config.time_check_interval_minutes">
                                        <small class="text-muted">How often to check time synchronization</small>
                                    </div>
                                </div>

                                <!-- Right Column: GPS Location -->
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3"><i class="bi bi-geo-alt me-2"></i>GPS Location</h6>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="gps_location_updates_enabled" x-model="$store.citrascope.config.gps_location_updates_enabled">
                                            <label class="form-check-label" for="gps_location_updates_enabled">
                                                Use GPS for ground station location
                                            </label>
                                        </div>
                                        <small class="text-muted d-block mt-2">
                                            When enabled, ground station location will be updated from GPS (if available).
                                            When disabled, server-provided location will be used for all operations.
                                        </small>
                                    </div>
                                    <div class="mb-3" x-show="$store.citrascope.config.gps_location_updates_enabled !== false">
                                        <label for="gps_update_interval_minutes" class="form-label">GPS Update Interval (minutes)</label>
                                        <input type="number" class="form-control" id="gps_update_interval_minutes"
                                            x-model.number="$store.citrascope.config.gps_update_interval_minutes"
                                            min="1" max="1440" step="1">
                                        <small class="text-muted d-block mt-2">
                                            How often to push location updates to the server (default: 5 minutes).
                                            Local operations always use current GPS. This only controls server sync frequency.
                                        </small>
                                    </div>

                                    <!-- GPS Status Details -->
                                    <div class="pt-3 border-top border-secondary" x-show="$store.citrascope.status?.gps_location">
                                        <h6 class="text-muted mb-3">Current GPS Status</h6>
                                        <div class="mb-2">
                                            <label class="form-label text-muted small">Position</label>
                                            <div class="font-monospace small" x-text="$store.citrascope.status?.gps_location ?
                                                `${$store.citrascope.status.gps_location.latitude.toFixed(6)}°, ${$store.citrascope.status.gps_location.longitude.toFixed(6)}°` :
                                                'Unavailable'"></div>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label text-muted small">Altitude</label>
                                            <div class="font-monospace small" x-text="$store.citrascope.status?.gps_location?.altitude != null ?
                                                `${Math.round($store.citrascope.status.gps_location.altitude)}m (${Math.round($store.citrascope.status.gps_location.altitude * 3.28084)}ft)` :
                                                'Unavailable'"></div>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label text-muted small">Fix Quality</label>
                                            <div class="font-monospace small">
                                                <span x-text="$store.citrascope.formatGPSLocation($store.citrascope.status?.gps_location)"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="pt-3 border-top border-secondary" x-show="!$store.citrascope.status?.gps_location">
                                        <div class="alert alert-secondary mb-0 small">
                                            <i class="bi bi-info-circle me-2"></i>GPS unavailable or no fix yet
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Settings Card -->
                <div class="col-12" x-data="{ advancedCardExpanded: $persist(false).as('advancedCard') }">
                    <div class="card bg-dark text-light border-secondary">
                        <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" @click="advancedCardExpanded = !advancedCardExpanded">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-sliders"></i>
                                <h5 class="mb-0">Advanced Settings</h5>
                                <small class="text-muted" x-show="!advancedCardExpanded"
                                       x-text="($store.citrascope.config.log_level || 'INFO') + ' • ' + ($store.citrascope.config.keep_images ? 'Keep images' : 'Delete images') + ($store.citrascope.config.use_dummy_api ? ' • Dummy API' : '')"></small>
                            </div>
                            <i class="bi" :class="advancedCardExpanded ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                        </div>
                        <div class="card-body" x-show="advancedCardExpanded">
                            <div class="row g-3">
                                <!-- Left Column: Logging -->
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3"><i class="bi bi-file-earmark-text me-2"></i>Logging</h6>
                                    <div class="mb-3">
                                        <label for="logLevel" class="form-label">Log Level</label>
                                        <select id="logLevel" class="form-select" x-model="$store.citrascope.config.log_level">
                                            <option value="DEBUG">DEBUG</option>
                                            <option value="INFO">INFO</option>
                                            <option value="WARNING">WARNING</option>
                                            <option value="ERROR">ERROR</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="file_logging_enabled" x-model="$store.citrascope.config.file_logging_enabled">
                                            <label class="form-check-label" for="file_logging_enabled">
                                                Enable file logging
                                            </label>
                                        </div>
                                    </div>
                                    <div>
                                        <small class="text-muted">
                                            Log file: <span class="text-secondary" x-text="$store.citrascope.config.log_file_path || 'Disabled'">Loading...</span>
                                        </small>
                                    </div>
                                </div>

                                <!-- Right Column: Image Storage -->
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3"><i class="bi bi-image me-2"></i>Image Storage</h6>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="keep_images" x-model="$store.citrascope.config.keep_images">
                                            <label class="form-check-label" for="keep_images">
                                                Keep captured images
                                            </label>
                                        </div>
                                        <small class="text-muted d-block mt-2">By default, images are deleted after upload unless this is enabled</small>
                                    </div>
                                    <div>
                                        <small class="text-muted">
                                            Images directory: <span class="text-secondary" x-text="$store.citrascope.config.images_dir_path || 'Loading...'">Loading...</span>
                                        </small>
                                    </div>
                                </div>

                                <!-- Development -->
                                <div class="col-12">
                                    <hr class="border-secondary">
                                    <h6 class="text-muted mb-3"><i class="bi bi-code-slash me-2"></i>Development</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="use_dummy_api"
                                               x-model="$store.citrascope.config.use_dummy_api">
                                        <label class="form-check-label" for="use_dummy_api">
                                            Use Dummy API (Local Testing)
                                        </label>
                                    </div>
                                    <small class="text-muted ms-4">Use a mock API server for testing, overrides api settings above</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="row">
                <div class="col">
                    <button type="submit" class="btn btn-primary" :disabled="$store.citrascope.isSavingConfig">
                        <span x-text="$store.citrascope.isSavingConfig ? 'Saving...' : 'Save Configuration'"></span>
                        <span x-show="$store.citrascope.isSavingConfig" class="spinner-border spinner-border-sm ms-2" role="status"></span>
                    </button>
                                    <small class="text-muted ms-3">
                                        Config file: <span class="text-secondary" x-text="$store.citrascope.config.config_file_path || 'Loading...'">Loading...</span>
                                    </small>
                </div>
            </div>
        </form>
    </div>
