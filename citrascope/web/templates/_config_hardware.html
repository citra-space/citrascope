                <!-- Hardware Configuration Card -->
                <div class="col-12" x-data="{ hardwareCardExpanded: $persist(true).as('hardwareCard') }">
                    <div class="card bg-dark text-light border-secondary">
                        <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" @click="hardwareCardExpanded = !hardwareCardExpanded">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-hdd-network"></i>
                                <h5 class="mb-0">Hardware Configuration</h5>
                                <small class="text-muted" x-show="!hardwareCardExpanded" x-text="($store.citrascope.hardwareAdapters.find(a => a.value === $store.citrascope.config.hardware_adapter)?.label || $store.citrascope.config.hardware_adapter || 'Not configured')"></small>
                            </div>
                            <i class="bi" :class="hardwareCardExpanded ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                        </div>
                        <div class="card-body" x-show="hardwareCardExpanded">
                            <div class="row g-3 mb-3">
                                <div class="col-12">
                                    <label for="hardwareAdapterSelect" class="form-label">Hardware Adapter <span class="text-danger">*</span></label>
                                    <select id="hardwareAdapterSelect" class="form-select" required x-model="$store.citrascope.config.hardware_adapter"
                                        @change="$store.citrascope.handleAdapterChange($event.target.value)">
                                        <option value="">-- Select Hardware Adapter --</option>
                                        <template x-for="adapter in $store.citrascope.hardwareAdapters" :key="adapter.value">
                                            <option :value="adapter.value" x-text="adapter.label"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>

                            <!-- Dynamic Adapter Settings Container -->
                            <div id="adapter-settings-container">
                                <template x-if="$store.citrascope.adapterFields.length > 0">
                                    <div>
                                        <h5 class="mb-3">Adapter Settings</h5>
                                        <!-- Group fields by group property -->
                                        <template x-for="[groupName, fields] in $store.citrascope.groupedAdapterFields" :key="groupName">
                                            <div class="card bg-dark border-secondary mb-3">
                                                <div class="card-header">
                                                    <h6 class="mb-0" x-text="groupName"></h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row g-3">
                                                        <template x-for="field in fields" :key="field.name">
                                                            <div x-data="adapterField(field)"
                                                                 class="col-12 col-md-4" x-show="field && field.name">
                                                                <label :for="inputId" class="form-label">
                                                                    <span x-text="field.friendly_name || field.name"></span>
                                                                    <span class="text-danger" x-show="field.required">*</span>
                                                                </label>

                                                                <!-- Boolean checkbox -->
                                                                <template x-if="isBoolean">
                                                                    <div class="form-check mt-2">
                                                                        <input class="form-check-input adapter-setting" type="checkbox"
                                                                               :id="inputId" :data-field="field.name" :data-type="field.type"
                                                                               x-model="field.value">
                                                                        <label class="form-check-label" :for="inputId" x-text="field.description"></label>
                                                                    </div>
                                                                </template>

                                                                <!-- Select dropdown -->
                                                                <template x-if="isSelect">
                                                                    <select :id="inputId" class="form-select adapter-setting"
                                                                            :data-field="field.name" :data-type="field.type"
                                                                            :required="field.required" @change="handleChange">
                                                                        <option value="" x-text="'-- Select ' + (field.friendly_name || field.name) + ' --'"></option>
                                                                        <template x-for="(opt, idx) in (field.options || [])" :key="(typeof opt === 'object' ? opt.value : opt) + '_' + idx">
                                                                            <option :value="typeof opt === 'object' ? opt.value : opt"
                                                                                    :selected="(typeof opt === 'object' ? opt.value : opt) === field.value"
                                                                                    x-text="typeof opt === 'object' ? opt.label : opt"></option>
                                                                        </template>
                                                                    </select>
                                                                </template>

                                                                <!-- Number input -->
                                                                <template x-if="isNumber">
                                                                    <input type="number" :id="inputId"
                                                                           class="form-control adapter-setting"
                                                                           :data-field="field.name" :data-type="field.type"
                                                                           :placeholder="field.placeholder || ''"
                                                                           :min="field.min" :max="field.max"
                                                                           :step="field.type === 'float' ? 'any' : '1'"
                                                                           :required="field.required"
                                                                           x-model="field.value" @input="handleChange">
                                                                </template>

                                                                <!-- Text input -->
                                                                <template x-if="isText">
                                                                    <input type="text" :id="inputId"
                                                                           class="form-control adapter-setting"
                                                                           :data-field="field.name" :data-type="field.type"
                                                                           :placeholder="field.placeholder || ''"
                                                                           :pattern="field.pattern || null"
                                                                           :required="field.required"
                                                                           x-model="field.value">
                                                                </template>

                                                                <small class="text-muted" x-show="!isBoolean && field.description"
                                                                       x-text="field.description"></small>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>

                            <!-- Missing Dependencies Alert (Config Page) -->
                            <div class="alert alert-warning mt-3" role="alert"
                                x-show="$store.citrascope.status?.missing_dependencies?.length > 0">
                                <template x-if="$store.citrascope.status?.missing_dependencies?.length > 0">
                                    <div>
                                        <strong><i class="bi bi-exclamation-triangle-fill me-2"></i>Missing Dependencies:</strong>
                                        <ul class="mb-0 mt-2">
                                            <template x-for="dep in $store.citrascope.status.missing_dependencies" :key="dep.device_name">
                                                <li>
                                                    <strong x-text="dep.device_name"></strong>: Missing <span x-text="dep.missing_packages"></span><br>
                                                    <code class="small" x-text="dep.install_cmd"></code>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </template>
                            </div>

                            <!-- Filter Configuration Section (shown when adapter supports filters) -->
                            <div id="filterConfigSection" x-show="$store.citrascope.filterConfigVisible" style="margin-top: 1.5rem;">
                                <hr class="border-secondary">
                                <h5 class="mb-3">Filter Configuration</h5>
                                <p class="text-muted mb-3" x-show="$store.citrascope.filterAdapterChangeMessageVisible">
                                    Save configuration to edit filter settings for this adapter
                                </p>
                                <div class="row">
                                    <!-- Filter List Column -->
                                    <div class="col-12 col-md-6">
                                        <h6 class="mb-2">Filters</h6>
                                        <div id="filterTableContainer">
                                            <table class="table table-dark table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Enabled</th>
                                                        <th>Name</th>
                                                        <th>Focus Position</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <template x-for="[filterId, filter] in Object.entries($store.citrascope.filters || {})" :key="filterId">
                                                        <tr x-data="filterRow(filter, filterId)">
                                                            <td>
                                                                <input type="checkbox" class="form-check-input filter-enabled-checkbox"
                                                                    :data-filter-id="filterId" x-model="$store.citrascope.filters[filterId].enabled">
                                                            </td>
                                                            <td>
                                                                <span class="badge" :style="badgeStyle" x-text="filter.name"></span>
                                                            </td>
                                                            <td>
                                                                <input type="number" class="form-control form-control-sm filter-focus-input"
                                                                    :data-filter-id="filterId" x-model.number="$store.citrascope.filters[filterId].focus_position" min="0" step="1">
                                                            </td>
                                                        </tr>
                                                    </template>
                                                </tbody>
                                            </table>
                                            <div class="text-muted small" x-show="Object.keys($store.citrascope.filters || {}).length === 0">
                                                No filters configured. Connect to hardware to discover filters.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Autofocus Column -->
                                    <div class="col-12 col-md-6">
                                        <h6 class="mb-2">Autofocus</h6>
                                        <div class="mb-3">
                                            <button type="button" class="btn btn-sm w-100"
                                                :class="$store.citrascope.status?.autofocus_requested ? 'btn-outline-warning' : 'btn-outline-primary'"
                                                @click="window.triggerAutofocus()">
                                                <span x-text="$store.citrascope.status?.autofocus_requested ? 'Cancel Autofocus' : 'Run Autofocus'">Run Autofocus</span>
                                                <span x-show="$store.citrascope.isAutofocusing" class="spinner-border spinner-border-sm ms-2" role="status"></span>
                                            </button>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label small text-muted">Last Autofocus</label>
                                            <div class="text-light" x-text="$store.citrascope.formatLastAutofocus($store.citrascope.status)">Never</div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="scheduled_autofocus_enabled" x-model="$store.citrascope.config.scheduled_autofocus_enabled">
                                                <label class="form-check-label" for="scheduled_autofocus_enabled">
                                                    Enable Scheduled Autofocus
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="autofocus_interval_minutes" class="form-label small">Autofocus Interval</label>
                                            <select id="autofocus_interval_minutes" class="form-select form-select-sm" x-model.number="$store.citrascope.config.autofocus_interval_minutes">
                                                <option value="30">30 minutes</option>
                                                <option value="60">60 minutes</option>
                                                <option value="120">120 minutes (2 hours)</option>
                                                <option value="180">180 minutes (3 hours)</option>
                                            </select>
                                        </div>
                                        <div class="small text-muted" x-show="$store.citrascope.status?.next_autofocus_minutes != null">
                                            Next autofocus in: <span x-text="$store.citrascope.status?.next_autofocus_minutes === 0 ? 'now (overdue)' : $store.citrascope.formatMinutes($store.citrascope.status?.next_autofocus_minutes || 0)">--</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
