    {#
        stage_box(stage, label, icon, color)
        stage  — Alpine store key, e.g. 'imaging'
        label  — display heading, e.g. 'Imaging'
        icon   — bootstrap-icons name, e.g. 'camera-fill'
        color  — Bootstrap color name for badge/icon, e.g. 'primary'
        col_attrs — extra HTML attrs on the col div, e.g. x-show="..."
    #}
    {% macro stage_box(stage, label, icon, color, col_attrs='') %}
    <div class="col-md" {{ col_attrs }}>
        <div class="border border-secondary rounded p-3 h-100">
            <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-{{ icon }} text-{{ color }}"></i>
                <h6 class="mb-0">{{ label }}</h6>
                <span class="badge bg-{{ color }}{% if color == 'warning' %} text-dark{% endif %} ms-auto"
                      x-show="$store.citrascope.status?.tasks_by_stage?.{{ stage }}?.length > 0"
                      x-text="$store.citrascope.status.tasks_by_stage.{{ stage }}.length"></span>
            </div>
            <div class="progress mb-2" style="height: 4px; cursor: default;"
                 x-show="$store.citrascope.status?.pipeline_stats?.{{ stage }}?.attempts > 0"
                 x-init="new bootstrap.Tooltip($el, {
                     placement: 'top',
                     trigger: 'hover',
                     title() {
                         const s = $store.citrascope.status?.pipeline_stats?.{{ stage }};
                         if (!s) return '';
                         return `${s.successes} ok · ${s.permanent_failures} failed · ${s.attempts} attempts`;
                     }
                 })">
                <div class="progress-bar bg-success" role="progressbar"
                     :style="`width: ${($store.citrascope.status.pipeline_stats.{{ stage }}.successes / $store.citrascope.status.pipeline_stats.{{ stage }}.attempts) * 100}%`"></div>
                <div class="progress-bar bg-danger" role="progressbar"
                     :style="`width: ${($store.citrascope.status.pipeline_stats.{{ stage }}.permanent_failures / $store.citrascope.status.pipeline_stats.{{ stage }}.attempts) * 100}%`"></div>
            </div>
            {{ task_list(stage) }}
        </div>
    </div>
    {% endmacro %}

    <!-- Macro for task list display -->
    {% macro task_list(stage_name) %}
        <template x-if="!$store.citrascope.status?.tasks_by_stage?.{{ stage_name }}?.length">
            <div class="text-muted text-center py-2">
                <small>Idle</small>
            </div>
        </template>
        <template x-if="$store.citrascope.status?.tasks_by_stage?.{{ stage_name }}?.length > 0">
            <div>
                <template x-for="(task, index) in $store.citrascope.status.tasks_by_stage.{{ stage_name }}" :key="task.task_id">
                    <div class="mb-2" :class="index < $store.citrascope.status.tasks_by_stage.{{ stage_name }}.length - 1 ? 'pb-2 border-bottom border-secondary' : ''">
                        <div>
                            <span class="fw-semibold" x-text="task.target_name || task.task_id"></span>
                            <span class="text-muted small ms-2" x-text="'(' + Math.floor(task.elapsed) + 's)'"></span>
                        </div>
                        <div class="text-muted small" x-show="task.status_msg">
                            <template x-if="task.retry_scheduled_time">
                                <span x-text="(() => {
                                    const now = Date.now() / 1000;
                                    const remaining = Math.max(0, Math.ceil(task.retry_scheduled_time - now));
                                    const match = task.status_msg.match(/^(.+?)retrying in \d+s\.\.\.$/);
                                    const prefix = match ? match[1] : task.status_msg.replace(/retrying in \d+s\.\.\./, '');
                                    return prefix + 'retrying in ' + remaining + 's...';
                                })()"></span>
                            </template>
                            <template x-if="!task.retry_scheduled_time">
                                <span x-text="task.status_msg"></span>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    {% endmacro %}

    <div id="monitoringSection" x-show="$store.citrascope.currentSection === 'monitoring'"
        x-effect="$store.citrascope.status && $nextTick(() => { document.querySelectorAll('[data-bs-toggle=tooltip]').forEach(el => { try { bootstrap.Tooltip.getOrCreateInstance(el); } catch (_) {} }); })">
        <div class="container">
            <div class="row g-3 mb-3">
                <div class="col-12 col-md-6">
                    <div class="card bg-dark text-light border-secondary h-100">
                        <div class="card-header">
                            System Status
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">Daemon</div>
                                <div class="col-6">
                                    <span class="badge rounded-pill" data-bs-toggle="tooltip" data-bs-placement="bottom"
                                        :class="$store.citrascope.wsConnected ? 'bg-success' : ($store.citrascope.wsReconnecting ? 'bg-warning text-dark' : 'bg-secondary')"
                                        :title="$store.citrascope.wsConnected ? 'Dashboard connected - receiving live updates' : ($store.citrascope.wsReconnecting ? 'Dashboard reconnecting' : 'Dashboard disconnected')"
                                        x-text="$store.citrascope.wsConnected ? 'Connected' : ($store.citrascope.wsReconnecting ? 'Reconnecting' : 'Connecting...')"></span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">Telescope</div>
                                <div class="col-6">
                                    <span class="badge rounded-pill" :class="$store.citrascope.status?.telescope_connected ? 'bg-success' : 'bg-danger'"
                                        x-text="$store.citrascope.status?.telescope_connected ? 'Connected' : 'Disconnected'"></span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">Camera</div>
                                <div class="col-6 d-flex align-items-center gap-2">
                                    <span class="badge rounded-pill" :class="$store.citrascope.status?.camera_connected ? 'bg-success' : 'bg-danger'"
                                        x-text="$store.citrascope.status?.camera_connected ? 'Connected' : 'Disconnected'"></span>
                                    <button class="btn btn-sm btn-outline-light"
                                        x-show="$store.citrascope.status?.camera_connected && $store.citrascope.status?.supports_direct_camera_control"
                                        @click="$store.citrascope.showCameraControl()">
                                        <i class="bi bi-camera"></i> Control
                                    </button>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">
                                    <span data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top" title="Controls whether the Citra.space server will automatically assign new observation tasks to this telescope">
                                        Automated Scheduling
                                    </span>
                                </div>
                                <div class="col-6 d-flex align-items-center gap-2">
                                    <span><span class="badge rounded-pill" :class="$store.citrascope.status?.automated_scheduling ? 'bg-success' : 'bg-secondary'"
                                        x-text="$store.citrascope.status?.automated_scheduling ? 'Enabled' : 'Disabled'"></span></span>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" title="Toggle automated scheduling"
                                            :checked="$store.citrascope.status?.automated_scheduling"
                                            @change="$store.citrascope.toggleAutomatedScheduling($event.target.checked)">
                                        <label class="form-check-label visually-hidden">Automated Scheduling</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">
                                    <span data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top" title="Controls whether this local daemon will execute tasks from its queue. Pause to safely stop observations without canceling scheduled tasks">
                                        Task Processing
                                    </span>
                                </div>
                                <div class="col-6 d-flex align-items-center gap-2">
                                    <span><span class="badge rounded-pill" :class="$store.citrascope.status?.processing_active ? 'bg-success' : 'bg-secondary'"
                                        x-text="$store.citrascope.status?.processing_active ? 'Enabled' : 'Disabled'"></span></span>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" title="Toggle task processing"
                                            :checked="$store.citrascope.status?.processing_active !== false"
                                            @change="$store.citrascope.toggleProcessing($event.target.checked)">
                                        <label class="form-check-label visually-hidden">Task Processing</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">
                                    <span data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top" title="System clock synchronization status. Accurate time is critical for astronomical observations">
                                        Time Sync
                                    </span>
                                </div>
                                <div class="col-6 d-flex align-items-center gap-2">
                                    <span>
                                        <span class="badge rounded-pill" data-bs-toggle="tooltip"
                                            :class="$store.citrascope.status?.time_health?.status === 'ok' ? 'bg-success' : ($store.citrascope.status?.time_health?.status === 'critical' ? 'bg-danger' : 'bg-secondary')"
                                            :title="$store.citrascope.status?.time_health?.status === 'ok' ? 'Time sync within threshold' : ($store.citrascope.status?.time_health?.status === 'critical' ? 'Time drift exceeded' : 'Unknown')"
                                            x-text="$store.citrascope.formatTimeOffset($store.citrascope.status?.time_health)"></span>
                                    </span>
                                </div>
                            </div>
                            <div class="row mb-2" x-show="$store.citrascope.config?.gps_location_updates_enabled !== false">
                                <div class="col-6 fw-semibold">
                                    <span data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top" title="GPS location from satellite fix. Used for telescope positioning and FITS metadata">
                                        GPS Location
                                    </span>
                                </div>
                                <div class="col-6">
                                    <span>
                                        <span class="badge rounded-pill" data-bs-toggle="tooltip"
                                            :class="$store.citrascope.status?.gps_location?.is_strong ? 'bg-success' : 'bg-secondary'"
                                            :title="$store.citrascope.status?.gps_location ? 'GPS fix available' : 'GPS unavailable or no fix'"
                                            x-text="$store.citrascope.formatGPSLocation($store.citrascope.status?.gps_location)"></span>
                                    </span>
                                </div>
                            </div>
                            <!-- Missing Dependencies Alert -->
                            <div class="alert alert-warning mt-3 mb-0" role="alert"
                                x-show="$store.citrascope.status?.missing_dependencies?.length > 0">
                                <template x-if="$store.citrascope.status?.missing_dependencies?.length > 0">
                                    <div>
                                        <strong><i class="bi bi-exclamation-triangle-fill me-2"></i>Missing Dependencies:</strong>
                                        <ul class="mb-0 mt-2">
                                            <template x-for="dep in $store.citrascope.status.missing_dependencies" :key="dep.device_name">
                                                <li>
                                                    <strong x-text="dep.device_name"></strong>: Missing <span x-text="dep.missing_packages"></span><br>
                                                    <code class="small" x-text="dep.install_cmd"></code>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="card bg-dark text-light border-secondary h-100">
                        <div class="card-header">
                            Telescope
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">Adapter</div>
                                <div class="col-6" x-text="$store.citrascope.status?.hardware_adapter || '-'"></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">RA / DEC</div>
                                <div class="col-6" x-text="($store.citrascope.status?.telescope_ra != null && $store.citrascope.status?.telescope_dec != null) ? ($store.citrascope.status.telescope_ra.toFixed(3) + '° / ' + $store.citrascope.status.telescope_dec.toFixed(3) + '°') : '-'"></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">Enabled Filters</div>
                                <div class="col-6 d-flex flex-wrap gap-1">
                                    <template x-if="$store.citrascope.enabledFilters.length === 0">
                                        <span>-</span>
                                    </template>
                                    <template x-for="f in $store.citrascope.enabledFilters" :key="f.name">
                                        <span class="badge me-1" :style="'background-color: ' + f.color + '; color: white;'" x-text="f.name"></span>
                                    </template>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6 fw-semibold">Ground Station</div>
                                <div class="col-6">
                                    <template x-if="$store.citrascope.status?.ground_station_name && $store.citrascope.status?.ground_station_url">
                                        <a :href="$store.citrascope.status.ground_station_url" target="_blank" class="ground-station-link" x-text="$store.citrascope.status.ground_station_name + ' ↗'"></a>
                                    </template>
                                    <template x-if="$store.citrascope.status?.ground_station_name && !$store.citrascope.status?.ground_station_url">
                                        <span x-text="$store.citrascope.status.ground_station_name"></span>
                                    </template>
                                    <template x-if="!$store.citrascope.status?.ground_station_name">
                                        <span>-</span>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="container">
            <!-- Active Tasks Card with Pipeline Stages -->
            <div class="row g-3 mb-3">
                <div class="col-12">
                    <div class="card bg-dark text-light border-secondary">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <span><i class="bi bi-lightning-charge-fill me-2"></i>Active Tasks</span>
                            <span class="text-muted small"
                                  x-show="$store.citrascope.status?.pipeline_stats?.tasks?.started > 0">
                                <span x-text="$store.citrascope.status.pipeline_stats.tasks.started"></span> run &middot;
                                <span class="text-success" x-text="$store.citrascope.status.pipeline_stats.tasks.succeeded"></span> ok
                                <template x-if="$store.citrascope.status.pipeline_stats.tasks.failed > 0">
                                    <span> &middot; <span class="text-danger" x-text="$store.citrascope.status.pipeline_stats.tasks.failed"></span> failed</span>
                                </template>
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 align-items-stretch">
                                {{ stage_box('imaging',    'Imaging',    'camera-fill',       'primary') }}

                                <!-- Arrow 1 (Imaging → Processing or Uploading) -->
                                <div class="col-auto d-none d-md-flex align-items-center px-2">
                                    <i class="bi bi-arrow-right text-secondary" style="font-size: 1.5rem;"></i>
                                </div>

                                {{ stage_box('processing', 'Processing', 'gear-fill',          'warning', 'x-show="$store.citrascope.config?.processors_enabled"') }}

                                <!-- Arrow 2 (Processing → Uploading, only shown when processing enabled) -->
                                <div class="col-auto align-items-center px-2" x-show="$store.citrascope.config?.processors_enabled" :class="{'d-flex': $store.citrascope.config?.processors_enabled}">
                                    <i class="bi bi-arrow-right text-secondary d-none d-md-inline-block" style="font-size: 1.5rem;"></i>
                                </div>

                                {{ stage_box('uploading',  'Submission', 'cloud-upload-fill',  'success') }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-12">
                    <div class="card bg-dark text-light border-secondary">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <span>Scheduled Tasks</span>
                            <span class="small text-secondary"><span x-text="$store.citrascope.status?.tasks_pending ?? $store.citrascope.tasks?.length ?? 0">0</span> scheduled</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <p class="p-3 text-muted-dark" x-show="$store.citrascope.tasks.length === 0">No scheduled tasks</p>
                                <table class="table table-dark table-hover mb-0" x-show="$store.citrascope.tasks.length > 0">
                                    <thead>
                                        <tr>
                                            <th>Target</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="task in $store.citrascope.tasks" :key="task.id">
                                            <tr x-data="taskRow(task)"
                                                class="task-row" :class="rowClass">
                                                <td class="fw-semibold" x-text="task.target"></td>
                                                <td class="text-secondary small" x-text="$store.citrascope.formatLocalTime(task.start_time)"></td>
                                                <td class="text-secondary small" x-text="task.stop_time ? $store.citrascope.formatLocalTime(task.stop_time) : '-'"></td>
                                                <td>
                                                    <span class="badge rounded-pill" :class="statusBadgeClass" x-text="statusText"></span>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
