    {#
        stage_box(stage, label, icon, color)
        stage  — Alpine store key, e.g. 'imaging'
        label  — display heading, e.g. 'Imaging'
        icon   — bootstrap-icons name, e.g. 'camera-fill'
        color  — Bootstrap color name for badge/icon, e.g. 'primary'
        col_attrs — extra HTML attrs on the col div, e.g. x-show="..."
    #}
    {% macro stage_box(stage, label, icon, color, col_attrs='') %}
    <div class="col-md" {{ col_attrs }}>
        <div class="border border-secondary rounded p-3 h-100">
            <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-{{ icon }} text-{{ color }}"></i>
                <h6 class="mb-0">{{ label }}</h6>
                <span class="badge bg-{{ color }}{% if color == 'warning' %} text-dark{% endif %} ms-auto"
                      x-show="$store.citrascope.status?.tasks_by_stage?.{{ stage }}?.length > 0"
                      x-text="$store.citrascope.status.tasks_by_stage.{{ stage }}.length"></span>
            </div>
            <div class="progress mb-2" style="height: 4px; cursor: default;"
                 x-show="$store.citrascope.status?.pipeline_stats?.{{ stage }}?.attempts > 0"
                 x-init="new bootstrap.Tooltip($el, {
                     placement: 'top',
                     trigger: 'hover',
                     title() {
                         const s = $store.citrascope.status?.pipeline_stats?.{{ stage }};
                         if (!s) return '';
                         const retries = s.attempts - s.successes - s.permanent_failures;
                         const retrySuffix = retries > 0 ? ` · ${retries} retr${retries === 1 ? 'y' : 'ies'}` : '';
                         return `${s.successes} ok · ${s.permanent_failures} failed${retrySuffix}`;
                     }
                 })">
                <div class="progress-bar bg-success" role="progressbar"
                     :style="`width: ${(() => { const s = $store.citrascope.status.pipeline_stats.{{ stage }}; const r = s.successes + s.permanent_failures; return r > 0 ? (s.successes / r) * 100 : 0; })()}%`"></div>
                <div class="progress-bar bg-danger" role="progressbar"
                     :style="`width: ${(() => { const s = $store.citrascope.status.pipeline_stats.{{ stage }}; const r = s.successes + s.permanent_failures; return r > 0 ? (s.permanent_failures / r) * 100 : 0; })()}%`"></div>
            </div>
            {{ task_list(stage) }}
        </div>
    </div>
    {% endmacro %}

    <!-- Macro for task list display -->
    {% macro task_list(stage_name) %}
        <template x-if="!$store.citrascope.status?.tasks_by_stage?.{{ stage_name }}?.length">
            <div class="text-muted text-center py-2">
                <small>Idle</small>
            </div>
        </template>
        <template x-if="$store.citrascope.status?.tasks_by_stage?.{{ stage_name }}?.length > 0">
            <div>
                <template x-for="(task, index) in $store.citrascope.status.tasks_by_stage.{{ stage_name }}" :key="task.task_id">
                    <div class="mb-2" :class="index < $store.citrascope.status.tasks_by_stage.{{ stage_name }}.length - 1 ? 'pb-2 border-bottom border-secondary' : ''">
                        <div>
                            <span class="fw-semibold" x-text="task.target_name || task.task_id"></span>
                            <span class="text-muted small ms-2" x-text="'(' + Math.floor(task.elapsed) + 's)'"></span>
                        </div>
                        <div class="text-muted small" x-show="task.status_msg">
                            <template x-if="task.retry_scheduled_time">
                                <span x-text="(() => {
                                    const now = Date.now() / 1000;
                                    const remaining = Math.max(0, Math.ceil(task.retry_scheduled_time - now));
                                    const match = task.status_msg.match(/^(.+?)retrying in \d+s\.\.\.$/);
                                    const prefix = match ? match[1] : task.status_msg.replace(/retrying in \d+s\.\.\./, '');
                                    return prefix + 'retrying in ' + remaining + 's...';
                                })()"></span>
                            </template>
                            <template x-if="!task.retry_scheduled_time">
                                <span x-text="task.status_msg"></span>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    {% endmacro %}

    <div id="monitoringSection" x-show="$store.citrascope.currentSection === 'monitoring'"
        x-effect="$store.citrascope.status && $nextTick(() => { document.querySelectorAll('[data-bs-toggle=tooltip]').forEach(el => { try { bootstrap.Tooltip.getOrCreateInstance(el); } catch (_) {} }); })">
        <div class="container">
            <div class="row g-3 mb-3">
                <div class="col-12 col-md-6">
                    <div class="card bg-dark text-light border-secondary h-100">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            System Status
                            <button class="btn btn-sm btn-danger"
                                    x-show="$store.citrascope.wsConnected"
                                    @click="emergencyStop()"
                                    data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="bottom"
                                    title="Stop mount, pause tasks, drain queue">
                                <i class="bi bi-stop-circle-fill"></i> Stop
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">Daemon</div>
                                <div class="col-6">
                                    <span class="badge rounded-pill" data-bs-toggle="tooltip" data-bs-placement="bottom"
                                        :class="$store.citrascope.wsConnected ? 'bg-success' : ($store.citrascope.wsReconnecting ? 'bg-warning text-dark' : 'bg-secondary')"
                                        :title="$store.citrascope.wsConnected ? 'Dashboard connected - receiving live updates' : ($store.citrascope.wsReconnecting ? 'Dashboard reconnecting' : 'Dashboard disconnected')"
                                        x-text="$store.citrascope.wsConnected ? 'Connected' : ($store.citrascope.wsReconnecting ? 'Reconnecting' : 'Connecting...')"></span>
                                </div>
                            </div>
                            <div class="row mb-2"
                                 x-data="{
                                     get checks() { return $store.citrascope.status?.safety_status?.checks || []; },
                                     get worst() {
                                         const order = ['safe','warn','stop','emergency'];
                                         let w = 'safe';
                                         for (const c of this.checks) {
                                             if (order.indexOf(c.action) > order.indexOf(w)) w = c.action;
                                         }
                                         return w;
                                     },
                                     get watchdog() { return $store.citrascope.status?.safety_status?.watchdog_alive; },
                                     get tip() {
                                         if (!this.checks.length) return 'No safety checks active';
                                         const labels = { safe: '✓', warn: '⚠', stop: '⏸', emergency: '✖' };
                                         const names = { operator_stop: 'Operator Stop', cable_wrap: 'Cable Wrap', disk_space: 'Disk Space', time_health: 'Time Health' };
                                         let lines = this.checks.map(c =>
                                             (labels[c.action] || '?') + ' ' + (names[c.name] || c.name)
                                         );
                                         if (this.watchdog === false) lines.push('✖ Watchdog offline');
                                         return lines.join('\n');
                                     }
                                 }"
                                 x-show="checks.length > 0">
                                <div class="col-6 fw-semibold">
                                    <span data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top"
                                          title="Safety monitor with watchdog thread. Checks hardware limits, disk space, and time health.">
                                        Safety
                                    </span>
                                </div>
                                <div class="col-6">
                                    <span class="badge rounded-pill"
                                          data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="bottom"
                                          style="white-space: pre-line;"
                                          :title="tip"
                                          :class="worst === 'emergency' ? 'bg-danger' : worst === 'stop' ? 'bg-warning text-dark' : worst === 'warn' ? 'bg-warning text-dark' : (watchdog === false ? 'bg-secondary' : 'bg-success')"
                                          x-text="worst === 'emergency' ? 'Emergency' : worst === 'stop' ? 'Hold' : worst === 'warn' ? 'Warning' : (watchdog === false ? 'Offline' : checks.length + ' checks OK')"></span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">Telescope</div>
                                <div class="col-6">
                                    <span class="badge rounded-pill" :class="$store.citrascope.status?.telescope_connected ? 'bg-success' : 'bg-danger'"
                                        x-text="$store.citrascope.status?.telescope_connected ? 'Connected' : 'Disconnected'"></span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">Camera</div>
                                <div class="col-6 d-flex align-items-center gap-2">
                                    <span class="badge rounded-pill" :class="$store.citrascope.status?.camera_connected ? 'bg-success' : 'bg-danger'"
                                        x-text="$store.citrascope.status?.camera_connected ? 'Connected' : 'Disconnected'"></span>
                                    <button class="btn btn-sm btn-outline-light"
                                        x-show="$store.citrascope.status?.camera_connected && $store.citrascope.status?.supports_direct_camera_control"
                                        @click="$store.citrascope.showCameraControl()">
                                        <i class="bi bi-camera"></i> Control
                                    </button>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">
                                    <span data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top" title="Controls whether the Citra.space server will automatically assign new observation tasks to this telescope">
                                        Automated Scheduling
                                    </span>
                                </div>
                                <div class="col-6 d-flex align-items-center gap-2">
                                    <span><span class="badge rounded-pill" :class="$store.citrascope.status?.automated_scheduling ? 'bg-success' : 'bg-secondary'"
                                        x-text="$store.citrascope.status?.automated_scheduling ? 'Enabled' : 'Disabled'"></span></span>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" title="Toggle automated scheduling"
                                            :checked="$store.citrascope.status?.automated_scheduling"
                                            @change="$store.citrascope.toggleAutomatedScheduling($event.target.checked)">
                                        <label class="form-check-label visually-hidden">Automated Scheduling</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">
                                    <span data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top" title="Controls whether this local daemon will execute tasks from its queue. Pause to safely stop observations without canceling scheduled tasks">
                                        Task Processing
                                    </span>
                                </div>
                                <div class="col-6 d-flex align-items-center gap-2">
                                    <span><span class="badge rounded-pill" :class="$store.citrascope.status?.processing_active ? 'bg-success' : 'bg-secondary'"
                                        x-text="$store.citrascope.status?.processing_active ? 'Enabled' : 'Disabled'"></span></span>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" title="Toggle task processing"
                                            :checked="$store.citrascope.status?.processing_active !== false"
                                            @change="$store.citrascope.toggleProcessing($event.target.checked)">
                                        <label class="form-check-label visually-hidden">Task Processing</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">
                                    <span data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top" title="System clock synchronization status. Accurate time is critical for astronomical observations">
                                        Time Sync
                                    </span>
                                </div>
                                <div class="col-6 d-flex align-items-center gap-2">
                                    <span>
                                        <span class="badge rounded-pill" data-bs-toggle="tooltip"
                                            :class="$store.citrascope.status?.time_health?.status === 'ok' ? 'bg-success' : ($store.citrascope.status?.time_health?.status === 'critical' ? 'bg-danger' : 'bg-secondary')"
                                            :title="$store.citrascope.status?.time_health?.status === 'ok' ? 'Time sync within threshold' : ($store.citrascope.status?.time_health?.status === 'critical' ? 'Time drift exceeded' : 'Unknown')"
                                            x-text="$store.citrascope.formatTimeOffset($store.citrascope.status?.time_health)"></span>
                                    </span>
                                </div>
                            </div>
                            <div class="row mb-2" x-show="$store.citrascope.config?.gps_location_updates_enabled !== false">
                                <div class="col-6 fw-semibold">
                                    <span data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top" title="GPS location from satellite fix. Used for telescope positioning and FITS metadata">
                                        GPS Location
                                    </span>
                                </div>
                                <div class="col-6">
                                    <span>
                                        <span class="badge rounded-pill" data-bs-toggle="tooltip"
                                            :class="$store.citrascope.status?.gps_location?.is_strong ? 'bg-success' : 'bg-secondary'"
                                            :title="$store.citrascope.status?.gps_location ? 'GPS fix available' : 'GPS unavailable or no fix'"
                                            x-text="$store.citrascope.formatGPSLocation($store.citrascope.status?.gps_location)"></span>
                                    </span>
                                </div>
                            </div>
                            <!-- Missing Dependencies Alert -->
                            <div class="alert alert-warning mt-3 mb-0" role="alert"
                                x-show="$store.citrascope.status?.missing_dependencies?.length > 0">
                                <template x-if="$store.citrascope.status?.missing_dependencies?.length > 0">
                                    <div>
                                        <strong><i class="bi bi-exclamation-triangle-fill me-2"></i>Missing Dependencies:</strong>
                                        <ul class="mb-0 mt-2">
                                            <template x-for="dep in $store.citrascope.status.missing_dependencies" :key="dep.device_name">
                                                <li>
                                                    <strong x-text="dep.device_name"></strong>: Missing <span x-text="dep.missing_packages"></span><br>
                                                    <code class="small" x-text="dep.install_cmd"></code>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="card bg-dark text-light border-secondary h-100">
                        <div class="card-header">
                            Telescope
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">Adapter</div>
                                <div class="col-6" x-text="$store.citrascope.status?.hardware_adapter || '-'"></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">RA / Dec</div>
                                <div class="col-6"
                                     x-data="{
                                         get ra() { return $store.citrascope.status?.telescope_ra; },
                                         get dec() { return $store.citrascope.status?.telescope_dec; }
                                     }"
                                     x-text="(ra != null && dec != null) ? (ra.toFixed(3) + '\u00b0 / ' + dec.toFixed(3) + '\u00b0') : '-'">
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">Alt / Az</div>
                                <div class="col-6 d-flex align-items-center gap-2"
                                     x-data="{
                                         get alt() { return $store.citrascope.status?.telescope_alt; },
                                         get az() { return $store.citrascope.status?.telescope_az; },
                                         get dotX() {
                                             if (this.alt == null || this.az == null) return 14;
                                             const a = (this.az / 360) * 2 * Math.PI;
                                             const r = 13 * Math.max(0, 1 - this.alt / 90);
                                             return 14 + r * Math.sin(a);
                                         },
                                         get dotY() {
                                             if (this.alt == null || this.az == null) return 14;
                                             const a = (this.az / 360) * 2 * Math.PI;
                                             const r = 13 * Math.max(0, 1 - this.alt / 90);
                                             return 14 - r * Math.cos(a);
                                         }
                                     }">
                                    <svg width="28" height="28" viewBox="0 0 28 28"
                                         x-show="alt != null && az != null"
                                         style="flex-shrink: 0;"
                                         data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top"
                                         title="Alt/Az polar — center is zenith, edge is horizon, N at top">
                                        <circle cx="14" cy="14" r="13" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1"/>
                                        <circle cx="14" cy="14" r="8.67" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/>
                                        <circle cx="14" cy="14" r="4.33" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/>
                                        <line x1="14" y1="1" x2="14" y2="27" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/>
                                        <line x1="1" y1="14" x2="27" y2="14" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/>
                                        <text x="14" y="4" text-anchor="middle" fill="rgba(255,255,255,0.3)" font-size="3.5">N</text>
                                        <text x="14" y="27" text-anchor="middle" fill="rgba(255,255,255,0.3)" font-size="3.5">S</text>
                                        <text x="26" y="15.5" text-anchor="end" fill="rgba(255,255,255,0.3)" font-size="3.5">E</text>
                                        <text x="2" y="15.5" text-anchor="start" fill="rgba(255,255,255,0.3)" font-size="3.5">W</text>
                                        <circle r="2.5" fill="#22c55e" opacity="0.9"
                                                :cx="dotX" :cy="dotY"/>
                                    </svg>
                                    <span x-text="(alt != null && az != null) ? (alt.toFixed(1) + '\u00b0 / ' + az.toFixed(1) + '\u00b0') : '-'"></span>
                                    <span class="badge rounded-pill bg-warning text-dark ms-auto"
                                          x-show="$store.citrascope.status?.telescope_connected && $store.citrascope.status?.mount_homing">
                                        <span class="spinner-border spinner-border-sm me-1" style="width: .6rem; height: .6rem;"></span>
                                        Homing...
                                    </span>
                                    <button class="btn btn-sm btn-outline-light ms-auto"
                                            x-show="$store.citrascope.status?.telescope_connected && !$store.citrascope.status?.mount_homing"
                                            @click="homeMount()"
                                            data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top"
                                            title="Send mount to home position">
                                        <i class="bi bi-house-door"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- Cable Wrap status (visible when safety monitor has a cable_wrap check) -->
                            <div class="row mb-2"
                                 x-data="{ get cw() { return ($store.citrascope.status?.safety_status?.checks || []).find(c => c.name === 'cable_wrap'); } }"
                                 x-show="cw">
                                <div class="col-6 fw-semibold">
                                    <span data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top"
                                          title="Cumulative cable rotation since last unwind. Soft limit pauses new tasks; hard limit aborts motion.">
                                        Cable Wrap
                                    </span>
                                </div>
                                <div class="col-6 d-flex align-items-center gap-2">
                                    <div class="progress position-relative" style="height: 1.3rem; min-width: 80px; max-width: 120px;"
                                         data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top"
                                         :title="'Soft ' + (cw?.soft_limit ?? 180) + '° / Hard ' + (cw?.hard_limit ?? 270) + '°'">
                                        <div class="progress-bar"
                                             :class="cw?.unwinding ? 'bg-info progress-bar-striped progress-bar-animated' : cw?.action === 'emergency' ? 'bg-danger' : cw?.action === 'stop' ? 'bg-warning' : 'bg-success'"
                                             :style="'width:' + Math.min(100, (Math.abs(cw?.cumulative_deg ?? 0) / (cw?.hard_limit ?? 270)) * 100) + '%'">
                                        </div>
                                        <span class="position-absolute top-50 start-50 translate-middle small fw-semibold"
                                              :class="(cw?.action === 'stop' && !cw?.unwinding) ? 'text-dark' : 'text-white'"
                                              x-text="(cw?.cumulative_deg >= 0 ? '+' : '') + (cw?.cumulative_deg ?? 0) + '°'"></span>
                                    </div>
                                    <button class="btn btn-sm btn-outline-warning"
                                            x-show="cw && !cw.unwinding && Math.abs(cw.cumulative_deg) > 5"
                                            @click="triggerCableUnwind()"
                                            data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top"
                                            title="Unwind cable by reversing mount rotation">
                                        <i class="bi bi-arrow-counterclockwise"></i> Unwind
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary"
                                            x-show="cw && !cw.unwinding && Math.abs(cw.cumulative_deg) > 0"
                                            @click="resetCableWrap()"
                                            data-bs-toggle="tooltip" data-bs-theme="dark" data-bs-placement="top"
                                            title="Reset counter to 0° — use after manually straightening cables">
                                        <i class="bi bi-0-circle"></i> Reset
                                    </button>
                                </div>
                            </div>
                            <div class="row mb-2" x-show="$store.citrascope.status?.telescope_connected && ($store.citrascope.status?.mount_horizon_limit != null || $store.citrascope.status?.mount_overhead_limit != null)">
                                <div class="col-6 fw-semibold">Alt Limits</div>
                                <div class="col-6">
                                    <span x-text="($store.citrascope.status?.mount_horizon_limit ?? '?') + '° min'"></span>
                                    /
                                    <span x-text="($store.citrascope.status?.mount_overhead_limit ?? '?') + '° max'"></span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 fw-semibold">Enabled Filters</div>
                                <div class="col-6 d-flex flex-wrap gap-1">
                                    <template x-if="$store.citrascope.enabledFilters.length === 0">
                                        <span>-</span>
                                    </template>
                                    <template x-for="f in $store.citrascope.enabledFilters" :key="f.name">
                                        <span class="badge me-1" :style="'background-color: ' + f.color + '; color: white;'" x-text="f.name"></span>
                                    </template>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6 fw-semibold">Ground Station</div>
                                <div class="col-6">
                                    <template x-if="$store.citrascope.status?.ground_station_name && $store.citrascope.status?.ground_station_url">
                                        <a :href="$store.citrascope.status.ground_station_url" target="_blank" class="ground-station-link" x-text="$store.citrascope.status.ground_station_name + ' ↗'"></a>
                                    </template>
                                    <template x-if="$store.citrascope.status?.ground_station_name && !$store.citrascope.status?.ground_station_url">
                                        <span x-text="$store.citrascope.status.ground_station_name"></span>
                                    </template>
                                    <template x-if="!$store.citrascope.status?.ground_station_name">
                                        <span>-</span>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!-- Safety alerts — shown when any check is non-safe -->
        <div class="container"
             x-data="{ get alerts() {
                 return ($store.citrascope.status?.safety_status?.checks || []).filter(c => c.action && c.action !== 'safe');
             }}"
             x-show="alerts.length > 0">
            <div class="row g-3 mb-3">
                <template x-for="alert in alerts" :key="alert.name">
                    <div class="col-12">
                        <div class="alert mb-0 d-flex align-items-center py-2"
                             :class="alert.action === 'emergency' ? 'alert-danger' : 'alert-warning'" role="alert">
                            <i class="bi me-2"
                               :class="alert.action === 'emergency' ? 'bi-exclamation-triangle-fill' : 'bi-exclamation-circle-fill'"></i>
                            <span>
                                <strong x-text="alert.action === 'emergency' ? 'EMERGENCY' : (alert.action === 'stop' ? 'Safety Hold' : 'Warning')"></strong>
                                &mdash;
                                <template x-if="alert.name === 'operator_stop'">
                                    <span>Operator stop active &mdash; all motion blocked.
                                        <button class="btn btn-sm btn-outline-light ms-2"
                                                @click="clearOperatorStop()">Clear Stop</button>
                                    </span>
                                </template>
                                <template x-if="alert.name === 'cable_wrap'">
                                    <span>Cable wrap at <span x-text="Math.abs(alert.cumulative_deg ?? 0)"></span>&deg;
                                        (<span x-text="alert.action === 'emergency' ? 'hard limit' : 'soft limit'"></span> reached).
                                        <template x-if="alert.unwinding">
                                            <span class="fw-semibold">Unwinding in progress...</span>
                                        </template>
                                    </span>
                                </template>
                                <template x-if="alert.name === 'disk_space'">
                                    <span>Low disk space
                                        <template x-if="alert.free_mb != null">
                                            (<span x-text="alert.free_mb >= 1000 ? (alert.free_mb / 1000).toFixed(1) + ' GB' : alert.free_mb + ' MB'"></span> free)
                                        </template>
                                        &mdash; <span x-text="alert.action === 'stop' ? 'imaging paused' : 'approaching limit'"></span>.
                                    </span>
                                </template>
                                <template x-if="alert.name === 'time_health'">
                                    <span>System clock drift is critical &mdash; observations may be inaccurate.</span>
                                </template>
                                <template x-if="!['operator_stop','cable_wrap','disk_space','time_health'].includes(alert.name)">
                                    <span>Safety check "<span x-text="alert.name"></span>" triggered.</span>
                                </template>
                            </span>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div class="container">
            <!-- Active Tasks Card with Pipeline Stages -->
            <div class="row g-3 mb-3">
                <div class="col-12">
                    <div class="card bg-dark text-light border-secondary">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <span><i class="bi bi-lightning-charge-fill me-2"></i>Active Tasks</span>
                            <span class="text-muted small"
                                  x-show="$store.citrascope.status?.pipeline_stats?.tasks?.started > 0">
                                <span x-text="$store.citrascope.status.pipeline_stats.tasks.started"></span> run &middot;
                                <span class="text-success" x-text="$store.citrascope.status.pipeline_stats.tasks.succeeded"></span> ok
                                <template x-if="$store.citrascope.status.pipeline_stats.tasks.failed > 0">
                                    <span> &middot; <span class="text-danger" x-text="$store.citrascope.status.pipeline_stats.tasks.failed"></span> failed</span>
                                </template>
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 align-items-stretch">
                                {{ stage_box('imaging',    'Imaging',    'camera-fill',       'primary') }}

                                <!-- Arrow 1 (Imaging → Processing or Uploading) -->
                                <div class="col-auto d-none d-md-flex align-items-center px-2">
                                    <i class="bi bi-arrow-right text-secondary" style="font-size: 1.5rem;"></i>
                                </div>

                                {{ stage_box('processing', 'Processing', 'gear-fill',          'warning', 'x-show="$store.citrascope.config?.processors_enabled"') }}

                                <!-- Arrow 2 (Processing → Uploading, only shown when processing enabled) -->
                                <div class="col-auto align-items-center px-2" x-show="$store.citrascope.config?.processors_enabled" :class="{'d-flex': $store.citrascope.config?.processors_enabled}">
                                    <i class="bi bi-arrow-right text-secondary d-none d-md-inline-block" style="font-size: 1.5rem;"></i>
                                </div>

                                {{ stage_box('uploading',  'Submission', 'cloud-upload-fill',  'success') }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-3" x-show="$store.citrascope.status?.autofocus_running">
                <div class="col-12">
                    <div class="alert alert-info d-flex align-items-center mb-0 py-2" role="alert">
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span>
                            Autofocus in progress &mdash; task processing is paused.
                            <span x-show="$store.citrascope.status?.autofocus_progress"
                                  class="ms-1 fw-semibold"
                                  x-text="$store.citrascope.status?.autofocus_progress"></span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-12">
                    <div class="card bg-dark text-light border-secondary">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <span>Scheduled Tasks</span>
                            <span class="small text-secondary"><span x-text="$store.citrascope.status?.tasks_pending ?? $store.citrascope.tasks?.length ?? 0">0</span> scheduled</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <p class="p-3 text-muted-dark" x-show="$store.citrascope.tasks.length === 0">No scheduled tasks</p>
                                <table class="table table-dark table-hover mb-0" x-show="$store.citrascope.tasks.length > 0">
                                    <thead>
                                        <tr>
                                            <th>Target</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="task in $store.citrascope.tasks" :key="task.id">
                                            <tr x-data="taskRow(task)"
                                                class="task-row" :class="rowClass">
                                                <td class="fw-semibold" x-text="task.target"></td>
                                                <td class="text-secondary small" x-text="$store.citrascope.formatLocalTime(task.start_time)"></td>
                                                <td class="text-secondary small" x-text="task.stop_time ? $store.citrascope.formatLocalTime(task.stop_time) : '-'"></td>
                                                <td>
                                                    <span class="badge rounded-pill" :class="statusBadgeClass" x-text="statusText"></span>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
