version: '3.8'
services:
  indi:
    image: ehippy/indiserver:latest
    container_name: test_indi
    restart: unless-stopped

  mock-citra-server:
    image: python:3.12
    container_name: mock-citra-server
    volumes:
      - ./mock_citra_server.py:/mock_citra_server.py
    ports:
      - "8080:8080"
    environment:
      - FLASK_ENV=development
    entrypoint: /bin/bash -c "apt-get update && apt-get install -y curl && pip install flask && python3 /mock_citra_server.py"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 2s
      timeout: 3s
      retries: 10
      start_period: 5s

  citrascope-test:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: citrascope-test
    environment:
      - CITRASCOPE_PERSONAL_ACCESS_TOKEN=${CITRASCOPE_PERSONAL_ACCESS_TOKEN}
      - CITRASCOPE_TELESCOPE_ID=${CITRASCOPE_TELESCOPE_ID}
      - CITRASCOPE_API_URL=http://mock-citra-server:8080
      - CITRASCOPE_INDI_SERVER_URL=test_indi
      - PYTHONUNBUFFERED=1
    depends_on:
      indi:
        condition: service_started
      mock-citra-server:
        condition: service_healthy
    command: ["pytest", "-m", "integration", "-v", "-s", "--log-cli-level=INFO", "tests/integration"]
    volumes:
      - ../..:/app
